
import FXBaseClass from './fx-base-class';
import _ from 'lodash';
import * as Tone from 'tone';

export default class Delay extends FXBaseClass {
    static fxName = 'delay';
    // static icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 20C10.6337 20 9.96341 19.5742 9.48421 18.9891C9.02909 18.4334 8.71671 17.7056 8.48267 16.9533C8.15321 15.8943 7.92705 14.6048 7.73621 13.2905C7.65897 12.7586 7.58752 12.2226 7.51735 11.6962L7.5088 11.6322C7.31298 10.1635 7.12519 8.76919 6.86294 7.60834C6.80525 7.75789 6.75052 7.91081 6.69872 8.06623C6.40971 8.93327 6.23296 9.81207 6.12878 10.4818C6.07701 10.8146 6.04391 11.0909 6.02389 11.2819C6.0139 11.3773 6.0072 11.4512 6.00308 11.4999L5.99877 11.5535L5.99791 11.5653L5.99779 11.567C5.9608 12.1178 5.48442 12.5345 4.93352 12.4978C4.38246 12.461 3.96552 11.9845 4.00225 11.4335L4.00235 11.4321C4.00235 11.4321 4.00003 11.43 4.00249 11.43L4.00292 11.4238L4.00442 11.4034C4.00571 11.3863 4.00759 11.3622 4.01018 11.3316C4.01534 11.2705 4.02329 11.1832 4.03478 11.0735C4.05773 10.8544 4.09494 10.5448 4.15255 10.1744C4.26711 9.43793 4.46537 8.44173 4.80135 7.43377C5.05331 6.6779 5.39544 5.87612 5.86494 5.16485C5.72271 5.0283 5.60853 5 5.50003 5C4.85798 5 4.33406 5.28569 3.8651 5.82681C3.37746 6.38947 2.99148 7.18794 2.69872 8.06623C2.40971 8.93327 2.23296 9.81207 2.12878 10.4818C2.07701 10.8146 2.04391 11.0909 2.02389 11.2819C2.0139 11.3773 2.0072 11.4512 2.00308 11.4999L1.99877 11.5535L1.99791 11.5653L1.99779 11.567C1.9608 12.1178 1.48442 12.5345 0.93352 12.4978C0.382458 12.461 -0.0344846 11.9845 0.00225283 11.4335L0.00248743 11.43L0.0029204 11.4238L0.00441576 11.4034C0.00570513 11.3863 0.00759341 11.3622 0.010176 11.3316C0.0153411 11.2705 0.0232909 11.1832 0.0347769 11.0735C0.0577319 10.8544 0.0949366 10.5448 0.152546 10.1744C0.267111 9.43793 0.465367 8.44173 0.801352 7.43377C1.13359 6.43706 1.62261 5.36053 2.35372 4.51695C3.1035 3.65181 4.14208 3 5.50003 3C6.21067 3 6.78936 3.2865 7.23889 3.71238C7.86197 3.27822 8.61284 3 9.50003 3C10.3664 3 11.0366 3.42583 11.5158 4.01089C11.971 4.56656 12.2833 5.29441 12.5174 6.04668C12.9802 7.53427 13.2392 9.4768 13.4827 11.3038L13.4913 11.3678C13.5656 11.9253 13.6388 12.472 13.7153 12.9994C13.8175 12.5285 13.9184 12.0424 14.0208 11.5474L14.0335 11.4857C14.3989 9.71937 14.7877 7.84008 15.3499 6.40163C15.6348 5.6726 15.9938 4.97545 16.4776 4.44749C16.9813 3.89776 17.6545 3.5 18.5 3.5C19.0523 3.5 19.5 3.94772 19.5 4.5C19.5 5.05228 19.0523 5.5 18.5 5.5C18.3456 5.5 18.1751 5.55536 17.9522 5.79861C17.7094 6.06362 17.459 6.49928 17.2127 7.12962C16.7189 8.39317 16.3601 10.1118 15.9793 11.9526L15.9665 12.0143C15.6027 13.7727 15.2158 15.6431 14.6577 17.0791C14.7808 17.3569 14.9065 17.5692 15.0315 17.7218C15.2241 17.9571 15.3664 18 15.5 18C15.6545 18 15.825 17.9446 16.0479 17.7014C16.2907 17.4364 16.541 17.0007 16.7874 16.3704C17.2812 15.1068 17.6399 13.3882 18.0208 11.5474L18.0335 11.4857C18.3989 9.71937 18.7877 7.84008 19.3499 6.40163C19.6348 5.6726 19.9938 4.97545 20.4776 4.44749C20.9813 3.89776 21.6545 3.5 22.5 3.5C23.0523 3.5 23.5 3.94772 23.5 4.5C23.5 5.05228 23.0523 5.5 22.5 5.5C22.3456 5.5 22.1751 5.55536 21.9522 5.79861C21.7094 6.06362 21.459 6.49928 21.2127 7.12962C20.7189 8.39317 20.3601 10.1118 19.9793 11.9526L19.9665 12.0143C19.6011 13.7806 19.2123 15.6599 18.6502 17.0984C18.3653 17.8274 18.0062 18.5246 17.5225 19.0525C17.0188 19.6022 16.3456 20 15.5 20C14.661 20 14.006 19.6007 13.5302 19.0441C13.5276 19.0469 13.5251 19.0497 13.5225 19.0525C13.0188 19.6022 12.3456 20 11.5 20ZM12.5016 17.0135C12.3709 17.2689 12.2403 17.4726 12.1115 17.6282C12.0903 17.6539 12.069 17.6783 12.0479 17.7014C11.825 17.9446 11.6545 18 11.5 18C11.3664 18 11.2241 17.9571 11.0315 17.7218C10.8147 17.4572 10.5958 17.0132 10.3924 16.3592C10.333 16.1682 10.2771 15.9672 10.2242 15.7571C9.91509 14.5292 9.7081 12.9942 9.49126 11.3678L9.48272 11.3038C9.23916 9.4768 8.98019 7.53427 8.51739 6.04668C8.45086 5.83283 8.37799 5.62096 8.29732 5.41445C8.65435 5.14167 9.0479 5 9.50003 5C9.63366 5 9.77591 5.04292 9.96859 5.27817C10.1853 5.54281 10.4042 5.98684 10.6077 6.64082C11.0145 7.94833 11.2549 9.72768 11.5088 11.6322L11.5173 11.6962L11.5174 11.6963C11.7609 13.5232 12.0199 15.4657 12.4827 16.9533C12.4889 16.9734 12.4952 16.9935 12.5016 17.0135Z" fill="currentColor"/></svg>'
    static icon = '<svg width="24" height="17" viewBox="0 0 24 17" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M9.48418 15.9891C9.96338 16.5742 10.6336 17 11.5 17C13.0953 17 14.0384 15.8168 14.6158 14.6451C15.1923 13.4752 15.5883 11.9568 15.9502 10.5693L15.9676 10.5024C16.351 9.03287 16.7015 7.70634 17.1783 6.73888C17.6634 5.75432 18.0953 5.5 18.5 5.5C19.0523 5.5 19.5 5.05228 19.5 4.5C19.5 3.94772 19.0523 3.5 18.5 3.5C16.9047 3.5 15.9616 4.68318 15.3842 5.85487C14.8077 7.02484 14.4117 8.5432 14.0498 9.93074L14.0324 9.99758C13.649 11.4671 13.2985 12.7937 12.8217 13.7611C12.3366 14.7457 11.9047 15 11.5 15C11.3664 15 11.2241 14.9571 11.0314 14.7218C10.8147 14.4572 10.5958 14.0132 10.3924 13.3592C9.98558 12.0517 9.74516 10.2723 9.49123 8.36784L9.48269 8.30376C9.23913 6.4768 8.98016 4.53427 8.51736 3.04668C8.28332 2.29441 7.97094 1.56656 7.51582 1.01089C7.03662 0.425826 6.36637 0 5.5 0C4.14205 0 3.10347 0.651813 2.35369 1.51695C1.62258 2.36053 1.13356 3.43706 0.801321 4.43377C0.465336 5.44173 0.26708 6.43793 0.152515 7.17442C0.0949061 7.54477 0.0577014 7.85444 0.0347465 8.07354C0.0232604 8.1832 0.0153106 8.27046 0.0101455 8.33163C0.0075629 8.36222 0.00567462 8.38631 0.00438525 8.40343L0.00288989 8.42384L0.00245693 8.43003L0.00231578 8.4321L0.00222232 8.43348C-0.0345151 8.98454 0.382427 9.46105 0.933489 9.49779C1.48438 9.53451 1.96077 9.11783 1.99776 8.56702L9.48418 15.9891ZM1.99776 8.56702C1.99863 8.54085 2 8.5 2 8.5L2.00305 8.49992C2.00717 8.45122 2.01386 8.37735 2.02386 8.28193C2.04388 8.09087 2.07698 7.81461 2.12875 7.48183C2.23293 6.81207 2.40968 5.93327 2.69869 5.06623C2.99145 4.18794 3.37743 3.38947 3.86507 2.82681C4.33403 2.28569 4.85795 2 5.5 2C5.63363 2 5.77588 2.04292 5.96856 2.27817C6.18531 2.54281 6.40418 2.98684 6.60764 3.64082C7.01442 4.94833 7.25484 6.72768 7.50877 8.63216L7.51731 8.69624C7.76087 10.5232 8.05455 12.5124 8.51736 14C8.7514 14.7523 9.02906 15.4334 9.48418 15.9891" fill="white" fill-opacity="0.9"/><path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M13.1141 13.7955C13.6203 14.2465 14.2558 14.5 15 14.5C16.4157 14.5 17.374 13.7582 18.0386 12.8336C18.6193 12.0257 19.0382 10.9903 19.4057 10.0819C19.4338 10.0126 19.4615 9.94403 19.489 9.87638C19.9045 8.85361 20.2771 7.99297 20.7723 7.37569C21.2242 6.81228 21.7371 6.5 22.5 6.5C23.0523 6.5 23.5 6.05228 23.5 5.5C23.5 4.94772 23.0523 4.5 22.5 4.5C21.0129 4.5 19.9633 5.18772 19.2121 6.12431C18.5041 7.00703 18.033 8.14639 17.636 9.12362C17.619 9.16558 17.6021 9.20724 17.5853 9.24861C17.1836 10.2381 16.8495 11.0612 16.4145 11.6664C16.001 12.2418 15.5843 12.5 15 12.5C14.7442 12.5 14.5828 12.4254 14.4445 12.3022C14.2821 12.1575 14.1093 11.9042 13.9451 11.4905C13.6076 10.6401 13.4331 9.46054 13.2399 8.10858C13.2362 8.08268 13.2325 8.05672 13.2288 8.03069C13.0498 6.77687 12.8486 5.36732 12.4139 4.27178C12.1874 3.70103 11.868 3.13406 11.3859 2.70451C10.8797 2.25351 10.2442 2 9.5 2C8.24502 2 7.25515 2.4408 6.51178 3.12222C5.79028 3.78359 5.3427 4.6314 5.06021 5.40826C4.77586 6.1902 4.63794 6.95788 4.56977 7.52029C4.53537 7.80409 4.51798 8.04204 4.50916 8.21179C4.50474 8.29681 4.50245 8.36513 4.50127 8.414C4.50068 8.43844 4.50036 8.45806 4.50019 8.47249L4.50003 8.49024L4.50001 8.49614L4.5 8.49832V8.5C4.5 9.05229 4.94772 9.5 5.5 9.5C6.0517 9.5 6.49906 9.05323 6.5 8.50174V8.50065L6.50005 8.49595L6.50068 8.46247C6.50145 8.43077 6.50307 8.38092 6.50647 8.31555C6.51327 8.18453 6.52713 7.99278 6.55523 7.76096C6.61206 7.29213 6.72414 6.6848 6.93979 6.09174C7.1573 5.4936 7.45972 4.96641 7.86322 4.59653C8.24485 4.2467 8.75498 4 9.5 4C9.75578 4 9.9172 4.07462 10.0555 4.19783C10.2179 4.34251 10.3907 4.59584 10.5549 5.00947C10.8924 5.85994 11.0669 7.03946 11.2601 8.39142C11.2638 8.41732 11.2675 8.44328 11.2712 8.46931C11.4502 9.72313 11.6514 11.1327 12.0861 12.2282C12.3126 12.799 12.632 13.3659 13.1141 13.7955Z" fill="white" fill-opacity="0.9"/></svg>'

    constructor (fxParameters) {
        super(fxParameters)
        this._mix = 0.2
        this._mixBeforeBypass = this._mix
        this.label = 'Tape delay'
        this._delayTime = '24t';
        this._feedback = 0.7
        this.isOn = fxParameters.isOn
    }

    setDelayTime (value) {
        this._delayTime = value
        if (this.isOn) {
            this.fx.delayTime.value = value
        }
    }
    setFeedback (value) {
        this._feedback = value
        if (this.isOn) {
            this.fx.feedback.value = value
        }
    }
    setMix (value, time) {
        this._mix = value
        if (this.isOn) {
            if (!_.isNil(time)) {
                this.fx.wet.setValueAtTime(value, time)
            } else {
                this.fx.wet.value = value
            }
        }
    }
    setBypass (value, time) {
        if (value === true && !this._override) {
            // set mix to 0 rather than turn off so that we can do this rapidly without needing to rebuild the audio chain
            if (this._mix > 0) {
                this._mixBeforeBypass = this._mix
            }
            this.setMix(0, time)
        } else {
            this.setMix(this._mixBeforeBypass, time)
        }
    }

    enable () {
        this.fx = new Tone.FeedbackDelay(this._delayTime, this._feedback)
        this.fx.wet.value = this._mix
        this.setBypass(true)
    }

    getAutomationOptions () {
        return [
            {
                label: 'Enabled',
                name: 'enabled',
                setParameter: this.setBypass.bind(this),
                calculateValue: function (value) {
                    return value === true ? false : true
                }
            },
            /*{
                label: 'Time',
                value: 'delayTime',
                calculateValue: function (value) {
                    // function to take a 0 - 1 value from interface and return appropriate value for this FX parameter
                    return numberRange(value, 0, 1, 0, 2000)
                }
            },
            {
                label: 'Feedback',
                value: 'feedback',
                calculateValue: function (value) {
                    // function to take a 0 - 1 value from interface and return appropriate value for this FX parameter
                    return value
                }
            },
            {
                label: 'Mix',
                value: 'mix',
                calculateValue: function (value) {
                    // function to take a 0 - 1 value from interface and return appropriate value for this FX parameter
                    return value
                }
            }*/
        ]
    }
}
