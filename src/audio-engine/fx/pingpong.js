
import FXBaseClass from './fx-base-class';
import _ from 'lodash';
import * as Tone from 'tone';

export default class PingPong extends FXBaseClass {
    static fxName = 'pingpong';
    // static icon = '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M11.5 20C10.6337 20 9.96341 19.5742 9.48421 18.9891C9.02909 18.4334 8.71671 17.7056 8.48267 16.9533C8.15321 15.8943 7.92705 14.6048 7.73621 13.2905C7.65897 12.7586 7.58752 12.2226 7.51735 11.6962L7.5088 11.6322C7.31298 10.1635 7.12519 8.76919 6.86294 7.60834C6.80525 7.75789 6.75052 7.91081 6.69872 8.06623C6.40971 8.93327 6.23296 9.81207 6.12878 10.4818C6.07701 10.8146 6.04391 11.0909 6.02389 11.2819C6.0139 11.3773 6.0072 11.4512 6.00308 11.4999L5.99877 11.5535L5.99791 11.5653L5.99779 11.567C5.9608 12.1178 5.48442 12.5345 4.93352 12.4978C4.38246 12.461 3.96552 11.9845 4.00225 11.4335L4.00235 11.4321C4.00235 11.4321 4.00003 11.43 4.00249 11.43L4.00292 11.4238L4.00442 11.4034C4.00571 11.3863 4.00759 11.3622 4.01018 11.3316C4.01534 11.2705 4.02329 11.1832 4.03478 11.0735C4.05773 10.8544 4.09494 10.5448 4.15255 10.1744C4.26711 9.43793 4.46537 8.44173 4.80135 7.43377C5.05331 6.6779 5.39544 5.87612 5.86494 5.16485C5.72271 5.0283 5.60853 5 5.50003 5C4.85798 5 4.33406 5.28569 3.8651 5.82681C3.37746 6.38947 2.99148 7.18794 2.69872 8.06623C2.40971 8.93327 2.23296 9.81207 2.12878 10.4818C2.07701 10.8146 2.04391 11.0909 2.02389 11.2819C2.0139 11.3773 2.0072 11.4512 2.00308 11.4999L1.99877 11.5535L1.99791 11.5653L1.99779 11.567C1.9608 12.1178 1.48442 12.5345 0.93352 12.4978C0.382458 12.461 -0.0344846 11.9845 0.00225283 11.4335L0.00248743 11.43L0.0029204 11.4238L0.00441576 11.4034C0.00570513 11.3863 0.00759341 11.3622 0.010176 11.3316C0.0153411 11.2705 0.0232909 11.1832 0.0347769 11.0735C0.0577319 10.8544 0.0949366 10.5448 0.152546 10.1744C0.267111 9.43793 0.465367 8.44173 0.801352 7.43377C1.13359 6.43706 1.62261 5.36053 2.35372 4.51695C3.1035 3.65181 4.14208 3 5.50003 3C6.21067 3 6.78936 3.2865 7.23889 3.71238C7.86197 3.27822 8.61284 3 9.50003 3C10.3664 3 11.0366 3.42583 11.5158 4.01089C11.971 4.56656 12.2833 5.29441 12.5174 6.04668C12.9802 7.53427 13.2392 9.4768 13.4827 11.3038L13.4913 11.3678C13.5656 11.9253 13.6388 12.472 13.7153 12.9994C13.8175 12.5285 13.9184 12.0424 14.0208 11.5474L14.0335 11.4857C14.3989 9.71937 14.7877 7.84008 15.3499 6.40163C15.6348 5.6726 15.9938 4.97545 16.4776 4.44749C16.9813 3.89776 17.6545 3.5 18.5 3.5C19.0523 3.5 19.5 3.94772 19.5 4.5C19.5 5.05228 19.0523 5.5 18.5 5.5C18.3456 5.5 18.1751 5.55536 17.9522 5.79861C17.7094 6.06362 17.459 6.49928 17.2127 7.12962C16.7189 8.39317 16.3601 10.1118 15.9793 11.9526L15.9665 12.0143C15.6027 13.7727 15.2158 15.6431 14.6577 17.0791C14.7808 17.3569 14.9065 17.5692 15.0315 17.7218C15.2241 17.9571 15.3664 18 15.5 18C15.6545 18 15.825 17.9446 16.0479 17.7014C16.2907 17.4364 16.541 17.0007 16.7874 16.3704C17.2812 15.1068 17.6399 13.3882 18.0208 11.5474L18.0335 11.4857C18.3989 9.71937 18.7877 7.84008 19.3499 6.40163C19.6348 5.6726 19.9938 4.97545 20.4776 4.44749C20.9813 3.89776 21.6545 3.5 22.5 3.5C23.0523 3.5 23.5 3.94772 23.5 4.5C23.5 5.05228 23.0523 5.5 22.5 5.5C22.3456 5.5 22.1751 5.55536 21.9522 5.79861C21.7094 6.06362 21.459 6.49928 21.2127 7.12962C20.7189 8.39317 20.3601 10.1118 19.9793 11.9526L19.9665 12.0143C19.6011 13.7806 19.2123 15.6599 18.6502 17.0984C18.3653 17.8274 18.0062 18.5246 17.5225 19.0525C17.0188 19.6022 16.3456 20 15.5 20C14.661 20 14.006 19.6007 13.5302 19.0441C13.5276 19.0469 13.5251 19.0497 13.5225 19.0525C13.0188 19.6022 12.3456 20 11.5 20ZM12.5016 17.0135C12.3709 17.2689 12.2403 17.4726 12.1115 17.6282C12.0903 17.6539 12.069 17.6783 12.0479 17.7014C11.825 17.9446 11.6545 18 11.5 18C11.3664 18 11.2241 17.9571 11.0315 17.7218C10.8147 17.4572 10.5958 17.0132 10.3924 16.3592C10.333 16.1682 10.2771 15.9672 10.2242 15.7571C9.91509 14.5292 9.7081 12.9942 9.49126 11.3678L9.48272 11.3038C9.23916 9.4768 8.98019 7.53427 8.51739 6.04668C8.45086 5.83283 8.37799 5.62096 8.29732 5.41445C8.65435 5.14167 9.0479 5 9.50003 5C9.63366 5 9.77591 5.04292 9.96859 5.27817C10.1853 5.54281 10.4042 5.98684 10.6077 6.64082C11.0145 7.94833 11.2549 9.72768 11.5088 11.6322L11.5173 11.6962L11.5174 11.6963C11.7609 13.5232 12.0199 15.4657 12.4827 16.9533C12.4889 16.9734 12.4952 16.9935 12.5016 17.0135Z" fill="currentColor"/></svg>'
    static icon = '<svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M7.63879 12.6881C7.97812 13.0573 8.431 13.3333 9.00077 13.3333C10.0644 13.3333 10.6931 12.5446 11.078 11.7634C11.4623 10.9834 11.7264 9.9712 11.9676 9.04618L11.9793 9.00162C12.2348 8.02191 12.4685 7.13756 12.7864 6.49259C13.1098 5.83622 13.3978 5.66667 13.6675 5.66667C14.0357 5.66667 14.3342 5.36819 14.3342 5C14.3342 4.63181 14.0357 4.33333 13.6675 4.33333C12.604 4.33333 11.9752 5.12212 11.5903 5.90325C11.206 6.68323 10.942 7.69547 10.7007 8.62049L10.6891 8.66505C10.4335 9.64475 10.1998 10.5291 9.88195 11.1741C9.55852 11.8305 9.27056 12 9.00077 12C8.90387 12 8.78381 11.9635 8.62052 11.7859C8.44633 11.5963 8.26613 11.2886 8.0861 10.8507C7.72555 9.97368 7.44579 8.78301 7.14996 7.51518L7.1408 7.47594C6.85599 6.25527 6.5545 4.9631 6.14855 3.97568C5.94316 3.47609 5.69106 3.00257 5.36264 2.64524C5.02331 2.27603 4.57044 2 4.00066 2C3.0851 2 2.41949 2.44541 1.97343 3.05367C1.54677 3.63546 1.31348 4.3696 1.18021 5.03592C1.04492 5.71237 1.00126 6.37927 0.990343 6.87061C0.984847 7.11794 0.987576 7.32467 0.991753 7.47086C0.993844 7.54404 0.996304 7.60226 0.998298 7.64307C0.999296 7.66348 1.00018 7.67955 1.00084 7.69097L1.00166 7.70459L1.00201 7.71009L1.00207 7.71101C1.02657 8.07839 1.34424 8.35635 1.71163 8.33186C2.07886 8.30738 2.35675 7.98996 2.33251 7.62277L2.33243 7.6215L2.33196 7.61368L2.33007 7.57796C2.32849 7.54552 2.32639 7.49633 2.32457 7.43278C2.32094 7.30554 2.31846 7.12165 2.32338 6.90023C2.33329 6.45406 2.37297 5.87096 2.48768 5.29741C2.60442 4.71373 2.7878 4.19787 3.04866 3.84216C3.29011 3.51292 3.58285 3.33333 4.00066 3.33333C4.09756 3.33333 4.21762 3.3698 4.38091 3.54747C4.55511 3.73701 4.7353 4.04475 4.91534 4.48266C5.27589 5.35965 5.55564 6.55032 5.85147 7.81815L5.86063 7.85739C6.14544 9.07806 6.44693 10.3702 6.85288 11.3577C7.05827 11.8572 7.31038 12.3308 7.63879 12.6881Z" fill = "white" fill - opacity="0.9" /><path opacity="0.5" fill-rule="evenodd" clip-rule="evenodd" d="M10.3187 2.64515C10.6581 2.27595 11.1109 1.99992 11.6807 1.99992C12.7443 1.99992 13.373 2.7887 13.7579 3.56983C14.1423 4.34981 14.4063 5.36205 14.6476 6.28707L14.6592 6.33164C14.9148 7.31134 15.1485 8.19569 15.4663 8.84066C15.7897 9.49704 16.0777 9.66659 16.3475 9.66659C16.7157 9.66659 17.0142 9.96506 17.0142 10.3333C17.0142 10.7014 16.7157 10.9999 16.3475 10.9999C15.2839 10.9999 14.6552 10.2111 14.2703 9.43001C13.8859 8.65002 13.6219 7.63778 13.3806 6.71276L13.369 6.6682C13.1134 5.6885 12.8797 4.80415 12.5619 4.15917C12.2384 3.5028 11.9505 3.33325 11.6807 3.33325C11.5838 3.33325 11.4637 3.36972 11.3005 3.54739C11.1263 3.73693 10.9461 4.04467 10.766 4.48257C10.4055 5.35957 10.1257 6.55024 9.82989 7.81807L9.82073 7.85731C9.53592 9.07798 9.23443 10.3702 8.82848 11.3576C8.62309 11.8572 8.37099 12.3307 8.04257 12.688C7.70324 13.0572 7.25037 13.3333 6.68059 13.3333C5.76503 13.3333 5.09943 12.8878 4.65336 12.2796C4.2267 11.6978 3.99341 10.9637 3.86014 10.2973C3.72485 9.62088 3.68119 8.95398 3.67027 8.46265C3.66478 8.21532 3.66751 8.00858 3.67168 7.86239C3.67377 7.78921 3.67623 7.73099 3.67823 7.69018C3.67923 7.66977 3.68011 7.6537 3.68077 7.64228L3.68159 7.62867L3.68194 7.62316L3.682 7.62224C3.7065 7.25486 4.02417 6.9769 4.39156 7.00139C4.75879 7.02588 5.03668 7.34329 5.01244 7.71048L5.01236 7.71175L5.01189 7.71957L5.01 7.75529C5.00842 7.78773 5.00632 7.83692 5.0045 7.90047C5.00087 8.02771 4.99839 8.2116 5.00331 8.43302C5.01322 8.87919 5.0529 9.46229 5.16761 10.0358C5.28435 10.6195 5.46773 11.1354 5.72859 11.4911C5.97004 11.8203 6.26278 11.9999 6.68059 11.9999C6.77749 11.9999 6.89755 11.9634 7.06084 11.7858C7.23504 11.5962 7.41523 11.2885 7.59527 10.8506C7.95582 9.9736 8.23557 8.78293 8.5314 7.5151L8.54056 7.47586C8.82537 6.25519 9.12686 4.96302 9.53281 3.9756C9.7382 3.476 9.99031 3.00249 10.3187 2.64515Z" fill="white" fill-opacity="0.9" /></svg >'

    constructor(fxParameters) {
        super(fxParameters)
        this._mix = 0.2
        this._mixBeforeBypass = this._mix
        this.label = 'Ping-pong delay'
        this._delayTime = '8t';
        this._feedback = 0.7
        this.isOn = fxParameters.isOn
    }

    setDelayTime(value) {
        this._delayTime = value
        if (this.isOn) {
            this.fx.delayTime.value = value
        }
    }
    setFeedback(value) {
        this._feedback = value
        if (this.isOn) {
            this.fx.feedback.value = value
        }
    }
    setMix(value, time) {
        this._mix = value
        if (this.isOn) {
            if (!_.isNil(time)) {
                this.fx.wet.setValueAtTime(value, time)
            } else {
                this.fx.wet.value = value
            }
        }
    }
    setBypass(value, time) {
        if (value === true && !this._override) {
            // set mix to 0 rather than turn off so that we can do this rapidly without needing to rebuild the audio chain
            if (this._mix > 0) {
                this._mixBeforeBypass = this._mix
            }
            this.setMix(0, time)
        } else {
            this.setMix(this._mixBeforeBypass, time)
        }
    }

    enable() {
        this.fx = new Tone.PingPongDelay(this._delayTime, this._feedback)
        this.fx.wet.value = this._mix
        this.setBypass(true)
    }

    getAutomationOptions() {
        return [
            {
                label: 'Enabled',
                name: 'enabled',
                setParameter: this.setBypass.bind(this),
                calculateValue: function (value) {
                    return value === true ? false : true
                }
            },
            /*{
                label: 'Time',
                value: 'delayTime',
                calculateValue: function (value) {
                    // function to take a 0 - 1 value from interface and return appropriate value for this FX parameter
                    return numberRange(value, 0, 1, 0, 2000)
                }
            },
            {
                label: 'Feedback',
                value: 'feedback',
                calculateValue: function (value) {
                    // function to take a 0 - 1 value from interface and return appropriate value for this FX parameter
                    return value
                }
            },
            {
                label: 'Mix',
                value: 'mix',
                calculateValue: function (value) {
                    // function to take a 0 - 1 value from interface and return appropriate value for this FX parameter
                    return value
                }
            }*/
        ]
    }
}
